#+title:  Mandelbrot Set

* A query that generates the (approximate) [[https://en.wikipedia.org/wiki/Mandelbrot_set][Mandelbrot set]]

  #+begin_src sql
    -- this works with BigQuery / GoogleSQL

    with recursive

    params as (select 50 as resolution, 50 as numIter),

    points as (
      select
        2 * m / resolution as x, 2 * n / resolution as y,
      from params cross join unnest(generate_array(- resolution, resolution)) as m cross join unnest(generate_array(- resolution, resolution)) as n
    ),

    iterations as (
      select
        1 as iteration, x as origX, y as origY, x as nextX, y as nextY,
      from points
      union all
      select
        iteration + 1, origX, origY, nextX * nextX - nextY * nextY + origX as nextX, 2 * nextX * nextY + origY as nextY,
      from iterations
      where iteration < (select numIter from params)
        and nextX * nextX + nextY * nextY <= 4
    ),

    summary as (
      select
        origX, origY, sum(case when (nextX * nextX + nextY * nextY) > 4 then 1 else 0 end) > 0 as excluded,
      from iterations
      group by origX, origY
    ),

    lines as (
      select
        array_to_string(array_agg(case when excluded then ' ' else '*' end order by origX), '') as line,
        sum(case when excluded then 0 else 1 end) = 0 as empty,
        row_number() over(order by origY) as row_num,
      from summary
      group by origY
      order by origY
    )

    select line from lines
    where row_num between (select min(row_num) from lines where not empty) and (select max(row_num) from lines where not empty)
    order by row_num
  #+end_src

* The result with ~resolution = 50~ and ~numIter = 50~

  #+begin_example
                                                      ,*


                                                   ,**
                                                  ,**
                                                 ,*****
                                                 ,*****
                                                ,******
                                                  ,***
                                             ,*  ********
                                        ,***  *************
                                        ,******************** **
                                          ,*********************
                                        ,*********************
                                     ,*************************
                                       ,************************
                                     ,**************************
                                      ,**************************
                             ,*      ****************************
                         ,*******    ****************************
                         ,*********  ****************************
                        ,**********  ****************************
                       ,************ ****************************
                       ,****************************************
                    ,*******************************************
    ,*********************************************************
                    ,*******************************************
                       ,****************************************
                       ,************ ****************************
                        ,**********  ****************************
                         ,*********  ****************************
                         ,*******    ****************************
                             ,*      ****************************
                                      ,**************************
                                     ,**************************
                                       ,************************
                                     ,*************************
                                        ,*********************
                                          ,*********************
                                        ,******************** **
                                        ,***  *************
                                             ,*  ********
                                                  ,***
                                                ,******
                                                 ,*****
                                                 ,*****
                                                  ,**
                                                   ,**


                                                      ,*
  #+end_example

* The result with ~resolution = 100~ and ~numIter = 100~

  #+begin_src sql
                                                                                                        ,*





                                                                                                  ,*
                                                                                                  ,**
                                                                                                ,* *
                                                                                               ,*******
                                                                                             ,*********
                                                                                             ,**********
                                                                                              ,*********
                                                                                             ,***********
                                                                                             ,**********
                                                                                              ,*********
                                                                                               ,*******
                                                                                                ,*****      *
                                                                                         ,* *************
                                                                                      ,********************* * **
                                                                             ,****    **************************
                                                                             ,*****  **************************** *
                                                                            ,***** *********************************  ****
                                                                             ,************************************** *****
                                                                                ,*****************************************
                                                                              ,******************************************
                                                                           ,*******************************************
                                                                           ,*********************************************
                                                                        ,************************************************
                                                                        ,************************************************
                                                                          ,************************************************
                                                                         ,*************************************************
                                                                        ,************************************************** *
                                                                      ,*******************************************************
                                                                       ,*************************************************** *
                                                                      ,*****************************************************
                                                      ,*             *******************************************************
                                               ,**  *  *               ******************************************************
                                              ,*** *********         ********************************************************
                                              ,***************        ********************************************************
                                               ,****************     *******************************************************
                                             ,*******************    ********************************************************
                                           ,* *******************    ********************************************************
                                            ,*********************   ********************************************************
                                           ,*********************** ********************************************************
                                           ,*********************** ********************************************************
                                           ,*********************** *******************************************************
                                     ,*  * *******************************************************************************
                                     ,**** *******************************************************************************
                                    ,***********************************************************************************
    ,*****************************************************************************************************************
                                    ,***********************************************************************************
                                     ,**** *******************************************************************************
                                     ,*  * *******************************************************************************
                                           ,*********************** *******************************************************
                                           ,*********************** ********************************************************
                                           ,*********************** ********************************************************
                                            ,*********************   ********************************************************
                                           ,* *******************    ********************************************************
                                             ,*******************    ********************************************************
                                               ,****************     *******************************************************
                                              ,***************        ********************************************************
                                              ,*** *********         ********************************************************
                                               ,**  *  *               ******************************************************
                                                      ,*             *******************************************************
                                                                      ,*****************************************************
                                                                       ,*************************************************** *
                                                                      ,*******************************************************
                                                                        ,************************************************** *
                                                                         ,*************************************************
                                                                          ,************************************************
                                                                        ,************************************************
                                                                        ,************************************************
                                                                           ,*********************************************
                                                                           ,*******************************************
                                                                              ,******************************************
                                                                                ,*****************************************
                                                                             ,************************************** *****
                                                                            ,***** *********************************  ****
                                                                             ,*****  **************************** *
                                                                             ,****    **************************
                                                                                      ,********************* * **
                                                                                         ,* *************
                                                                                                ,*****      *
                                                                                               ,*******
                                                                                              ,*********
                                                                                             ,**********
                                                                                             ,***********
                                                                                              ,*********
                                                                                             ,**********
                                                                                             ,*********
                                                                                               ,*******
                                                                                                ,* *
                                                                                                  ,**
                                                                                                  ,*





                                                                                                        ,*
  #+end_src
